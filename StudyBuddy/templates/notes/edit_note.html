{% extends 'base.html' %}

{% block title %}Редактировать конспект{% endblock %}

{% block page_title %}Редактировать конспект{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">
    <form id="note-form" method="post" class="mt-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="title" class="form-label">Название</label>
            <input type="text" name="title" id="title" value="{{ note.title }}" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="content" class="form-label">Содержимое</label>
            <!-- Редактор Quill -->
            <div id="editor-container" style="height: 400px; border: 1px solid #ccc; border-radius: 5px; padding: 10px;"></div>
            <input type="hidden" name="content" id="content">
        </div>
        <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{% url 'groups:group_detail' note.group.id %}" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
</div>

<!-- Подключение Quill.js -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

<script>
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link', 'image']
            ]
        }
    });

    // Установить содержимое из базы данных
    quill.setContents({{ note.content|safe }});

    // При отправке формы сохранить содержимое редактора
    document.getElementById('note-form').onsubmit = function () {
        document.getElementById('content').value = JSON.stringify(quill.getContents());
    };
</script>
{% endblock %}



{#<!DOCTYPE html>#}
{#<html lang="ru">#}
{#<head>#}
{#    <meta charset="UTF-8">#}
{#    <meta name="viewport" content="width=device-width, initial-scale=1.0">#}
{#    <title>Редактировать конспект</title>#}
{#    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">#}
{#    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>#}
{#    <style>#}
{#        body {#}
{#            font-family: Arial, sans-serif;#}
{#            margin: 0;#}
{#            padding: 20px;#}
{#            background-color: #f5f5f5;#}
{#        }#}
{##}
{#        #editor-container {#}
{#            height: 400px;#}
{#            border: 1px solid #ccc;#}
{#            border-radius: 5px;#}
{#            padding: 10px;#}
{#            overflow-y: auto;#}
{#            background-color: #fff;#}
{#        }#}
{##}
{#        input[type="text"] {#}
{#            width: 100%;#}
{#            padding: 10px;#}
{#            margin-bottom: 20px;#}
{#            border: 1px solid #ccc;#}
{#            border-radius: 5px;#}
{#            font-size: 16px;#}
{#        }#}
{##}
{#        .button-group {#}
{#            margin-top: 20px;#}
{#            display: flex;#}
{#            justify-content: space-between;#}
{#        }#}
{##}
{#        button, .cancel-button {#}
{#            padding: 10px 20px;#}
{#            font-size: 16px;#}
{#            border: none;#}
{#            border-radius: 5px;#}
{#            cursor: pointer;#}
{#        }#}
{##}
{#        button {#}
{#            background-color: #007bff;#}
{#            color: white;#}
{#        }#}
{##}
{#        button:hover {#}
{#            background-color: #0056b3;#}
{#        }#}
{##}
{#        .cancel-button {#}
{#            background-color: #ccc;#}
{#            color: black;#}
{#            text-decoration: none;#}
{#            text-align: center;#}
{#        }#}
{##}
{#        .cancel-button:hover {#}
{#            background-color: #aaa;#}
{#        }#}
{#    </style>#}
{#</head>#}
{#<body>#}
{#    <h1>Редактировать конспект</h1>#}
{#    <form id="note-form" method="post">#}
{#        {% csrf_token %}#}
{#        <!-- Поле для названия конспекта -->#}
{#        <input type="text" name="title" id="title" value="{{ note.title }}" placeholder="Введите название конспекта" required>#}
{##}
{#        <!-- Редактор Quill -->#}
{#        <div id="editor-container"></div>#}
{#        <input type="hidden" name="content" id="content">#}
{##}
{#        <!-- Кнопки -->#}
{#        <div class="button-group">#}
{#            <button type="submit">Сохранить</button>#}
{#            <a href="{% url 'groups:group_detail' note.group.id %}" class="cancel-button">Отмена</a>#}
{#        </div>#}
{#    </form>#}
{##}
{#    <script>#}
{#        let isRemoteChange = false; // Флаг для различения источников изменений#}
{##}
{#        const quill = new Quill('#editor-container', {#}
{#            theme: 'snow',#}
{#            modules: {#}
{#                toolbar: [#}
{#                    [{ header: [1, 2, false] }],#}
{#                    ['bold', 'italic', 'underline'],#}
{#                    [{ list: 'ordered' }, { list: 'bullet' }],#}
{#                    ['link', 'image']#}
{#                ]#}
{#            }#}
{#        });#}
{##}
{#        // Установить начальное содержимое#}
{#        quill.setContents({{ note.content|safe }});#}
{##}
{#        // Подключение WebSocket#}
{#        const socket = new WebSocket(`ws://${window.location.host}/ws/notes/{{ note.id }}/`);#}
{##}
{#        // Обработка пользовательских изменений#}
{#        quill.on('text-change', function (delta, oldDelta, source) {#}
{#            if (source === 'user') { // Только если изменения от пользователя#}
{#                isRemoteChange = true; // Установить флаг, чтобы предотвратить цикл#}
{#                socket.send(JSON.stringify({ content: quill.getContents() }));#}
{#            }#}
{#        });#}
{##}
{#        // Обработка изменений от сервера#}
{#        socket.onmessage = function (event) {#}
{#            const data = JSON.parse(event.data);#}
{#            if (!isRemoteChange) { // Изменения от сервера#}
{#                quill.setContents(data.content); // Применяем изменения#}
{#            }#}
{#            isRemoteChange = false; // Сбрасываем флаг#}
{#        };#}
{##}
{#        // При отправке формы сохраняем содержимое в скрытое поле#}
{#        const form = document.getElementById('note-form');#}
{#        form.onsubmit = function () {#}
{#            const contentField = document.getElementById('content');#}
{#            contentField.value = JSON.stringify(quill.getContents());#}
{#        };#}
{##}
{#        // Обработка ошибок WebSocket#}
{#        socket.onerror = function (error) {#}
{#            console.error('WebSocket Error: ', error);#}
{#        };#}
{##}
{#        // Закрытие WebSocket#}
{#        socket.onclose = function () {#}
{#            console.warn('WebSocket connection closed.');#}
{#        };#}
{#    </script>#}
{#</body>#}
{#</html>#}