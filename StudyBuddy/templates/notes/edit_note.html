{% extends "base.html" %}
{% block title %}Редактировать конспект{% endblock %}
{% block page_title %}Редактировать конспект{% endblock %}

{% block content %}
<div class="w-full max-w-2xl mx-auto">
    <form id="note-form" method="post" class="card bg-base-100 shadow-md p-6 space-y-6">
        {% csrf_token %}
        <div class="form-control">
            <label for="title" class="label">
                <span class="label-text font-medium">Название конспекта</span>
            </label>
            <input type="text" name="title" id="title" value="{{ note.title }}" class="input input-bordered w-full" required>
        </div>
        <div class="form-control">
            <label class="label">
                <span class="label-text font-medium">Содержимое</span>
            </label>
            <div id="editor-container" class="bg-white rounded border border-base-300 min-h-[300px] max-h-[600px] overflow-auto"></div>
            <input type="hidden" name="content" id="content">
        </div>
        <div class="flex gap-2 justify-between">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{% url 'groups:group_detail' note.group.id %}" class="btn btn-outline">Отмена</a>
        </div>
    </form>
</div>

<!-- Подключение Quill.js -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    let isRemoteChange = false; // Флаг для различения источников изменений

    // Инициализация редактора Quill
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{header: [1, 2, false]}],
                ['bold', 'italic', 'underline'],
                [{list: 'ordered'}, {list: 'bullet'}],
                ['link', 'image']
            ]
        }
    });

    // Установить начальное содержимое
    quill.setContents({{ note.content|safe }});

    // Подключение WebSocket
    const socket = new WebSocket(`ws://${window.location.host}/ws/notes/{{ note.id }}/`);

    // Обработка пользовательских изменений
    quill.on('text-change', function (delta, oldDelta, source) {
        if (source === 'user') { // Только если изменения от пользователя
            isRemoteChange = true; // Установить флаг, чтобы предотвратить цикл
            socket.send(JSON.stringify({content: quill.getContents()}));
        }
    });

    // Обработка изменений от сервера
    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (!isRemoteChange) { // Изменения от сервера
            quill.setContents(data.content); // Применяем изменения
        }
        isRemoteChange = false; // Сбрасываем флаг
    };

    // При отправке формы сохраняем содержимое в скрытое поле
    const form = document.getElementById('note-form');
    form.onsubmit = function () {
        const contentField = document.getElementById('content');
        contentField.value = JSON.stringify(quill.getContents());
    };

    // Обработка ошибок WebSocket
    socket.onerror = function (error) {
        console.error('WebSocket Error: ', error);
    };

    // Закрытие WebSocket
    socket.onclose = function () {
        console.warn('WebSocket connection closed.');
    };
</script>
{% endblock %}