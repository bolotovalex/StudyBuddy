{% extends 'base.html' %}

{% block page_title %}
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
    <span class="text-xl font-semibold break-words">{{ group.name }}</span>
    <form method="post" action="{% url 'groups:leave_group' group.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-error btn-sm">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</button>
    </form>
</div>
{% endblock %}

{% block content %}
<div class="w-full max-w-3xl mx-auto">

    <!-- DaisyUI Tabs -->
    <div role="tablist" class="tabs tabs-bordered mb-6 overflow-x-auto whitespace-nowrap">
        <a role="tab" class="tab tab-bordered {% if not tab or tab == 'announcements' %}tab-active{% endif %}"
            href="#announcements">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
        <a role="tab" class="tab tab-bordered {% if tab == 'documents' %}tab-active{% endif %}"
            href="#documents">–î–æ–∫—É–º–µ–Ω—Ç—ã</a>
        <a role="tab" class="tab tab-bordered {% if tab == 'notes' %}tab-active{% endif %}" href="#notes">–ö–æ–Ω—Å–ø–µ–∫—Ç—ã</a>
        <a role="tab" class="tab tab-bordered {% if tab == 'meetings' %}tab-active{% endif %}"
            href="#meetings">–í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏</a>
        <a role="tab" class="tab tab-bordered {% if tab == 'members' %}tab-active{% endif %}" href="#members">–£—á–∞—Å—Ç–Ω–∏–∫–∏
            –≥—Ä—É–ø–ø—ã</a>
    </div>

    <!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è -->
    <div id="announcements" class="{% if not tab or tab == 'announcements' %}block{% else %}hidden{% endif %}">
        <h2 class="text-lg font-semibold mb-3">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
        <div id="message-list" class="space-y-2 mb-4">
            {% for message in messages %}
            <div class="bg-base-200 rounded p-3">
                <span class="text-xs text-base-content/60">{{ message.timestamp|date:"d.m.Y H:i" }} ‚Äî {{
                    message.user.username }}</span><br>
                {{ message.content }}
            </div>
            {% empty %}
            <div class="text-base-content/60">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
            {% endfor %}
        </div>
        <form id="chat-form" method="post" class="space-y-2">
            {% csrf_token %}
            <textarea name="content" id="content" class="textarea textarea-bordered w-full"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
            <input type="hidden" name="group_id" value="{{ group.id }}">
            <button type="submit" class="btn btn-primary w-full">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
        <hr class="my-6">

        {% if request.user == group.owner %}
        <h3 class="font-semibold mb-2">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å—Ç—É–ø</h3>
        <ul class="space-y-2">
            {% for user in group.access_requests.all %}
            <li class="flex justify-between items-center bg-base-200 rounded p-2">
                <span>{{ user.username }}</span>
                <div class="flex gap-2">
                    <a href="{% url 'groups:accept_request' group.pk user.pk %}"
                        class="btn btn-success btn-xs">–ü—Ä–∏–Ω—è—Ç—å</a>
                    <a href="{% url 'groups:decline_request' group.pk user.pk %}"
                        class="btn btn-error btn-xs">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
                </div>
            </li>
            {% empty %}
            <li class="text-base-content/60">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –¥–æ—Å—Ç—É–ø.</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
    <div id="documents" class="{% if tab == 'documents' %}block{% else %}hidden{% endif %}">
        <h2 class="text-lg font-semibold mb-3">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
            {% for document in documents %}
            <div class="flex flex-col items-center bg-base-200 rounded p-3">
                <!-- –ó–Ω–∞—á–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ (–ø—Ä–∏–º–µ—Ä –¥–ª—è –±–∞–∑–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤) -->
                <div class="mb-2">
                    {% if document.get_file_type == 'pdf' %}
                    <span class="text-5xl text-error">üìÑ</span>
                    {% elif document.get_file_type == 'word' %}
                    <span class="text-5xl text-primary">üìÑ</span>
                    {% elif document.get_file_type == 'excel' %}
                    <span class="text-5xl text-success">üìÑ</span>
                    {% else %}
                    <span class="text-5xl">üìÑ</span>
                    {% endif %}
                </div>
                <a href="{{ document.file.url }}" target="_blank" class="font-medium mb-2 text-center break-words">{{
                    document.get_file_name }}</a>
                <a href="{% url 'documents:delete_document' document.id %}"
                    class="btn btn-outline btn-error btn-xs">–£–¥–∞–ª–∏—Ç—å</a>
            </div>
            {% empty %}
            <p class="text-base-content/60 col-span-full">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
            {% endfor %}
        </div>
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
        <form method="post" enctype="multipart/form-data" action="{% url 'documents:add_document' group.id %}"
            class="space-y-2">
            {% csrf_token %}
            <label class="form-control w-full mb-2">
                <span class="label-text">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:</span>
                <input type="file" name="file" id="file" class="file-input file-input-bordered w-full" required>
            </label>
            <textarea name="description" class="textarea textarea-bordered w-full"
                placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
            <button type="submit" class="btn btn-primary w-full">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </form>
    </div>

    <!-- –ö–æ–Ω—Å–ø–µ–∫—Ç—ã -->
    <div id="notes" class="{% if tab == 'notes' %}block{% else %}hidden{% endif %}">
        <h2 class="text-lg font-semibold mb-3">–ö–æ–Ω—Å–ø–µ–∫—Ç—ã</h2>
        <ul class="space-y-2">
            {% for note in notes %}
            <li class="bg-base-200 rounded p-2">
                <a href="{% url 'notes:edit_note' note.id %}" class="link">{{ note.title }}</a>
            </li>
            {% empty %}
            <li class="text-base-content/60">–ù–µ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</li>
            {% endfor %}
        </ul>
        <a href="{% url 'notes:add_note' group.id %}" class="btn btn-outline btn-primary mt-4 w-full">–°–æ–∑–¥–∞—Ç—å
            –∫–æ–Ω—Å–ø–µ–∫—Ç</a>
    </div>

    <!-- –í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏ -->
    <div id="meetings" class="{% if tab == 'meetings' %}block{% else %}hidden{% endif %}">
        <h2 class="text-lg font-semibold mb-3">–í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏</h2>
        <ul class="space-y-2">
            {% for meeting in meetings %}
            <li class="bg-base-200 rounded p-2 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <span>
                    <a href="{{ meeting.link }}" class="link">{{ meeting.title }}</a>
                    ‚Äî {{ meeting.scheduled_at|date:"d.m.Y H:i" }}
                </span>
            </li>
            {% empty %}
            <li class="text-base-content/60">–ù–µ—Ç –≤–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á</li>
            {% endfor %}
        </ul>
        <form method="post" action="{% url 'meetings:add_meeting' group.id %}" class="space-y-2 mt-4">
            {% csrf_token %}
            <input type="text" name="title" class="input input-bordered w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏" required>
            {# <input type="url" name="link" class="input input-bordered w-full" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É"
                required> #}
            <input type="datetime-local" name="scheduled_at" class="input input-bordered w-full" required>
            <button type="submit" class="btn btn-primary w-full">–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</button>
        </form>
    </div>

    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã -->
    <div id="members" class="{% if tab == 'members' %}block{% else %}hidden{% endif %}">
        <h2 class="text-lg font-semibold mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h2>
        <ul class="space-y-2">
            {% for member in members %}
            <li class="bg-base-200 rounded p-2 flex justify-between items-center">
                <span>{{ member.username }}</span>
                {% if member == group.owner %}
                <span class="badge badge-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                {% endif %}
            </li>
            {% empty %}
            <li class="text-base-content/60">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ (DaisyUI tabs —Å —è–∫–æ—Ä—è–º–∏)
    document.querySelectorAll('[role="tab"]').forEach(tab => {
        tab.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelectorAll('[role="tab"]').forEach(t => t.classList.remove('tab-active'));
            this.classList.add('tab-active');
            document.querySelectorAll('#announcements, #documents, #notes, #meetings, #members').forEach(block => block.classList.add('hidden'));
            document.querySelector(this.getAttribute('href')).classList.remove('hidden');
            // –î–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∫–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
            localStorage.setItem('activeTab', this.getAttribute('href'));
        });
    });
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –º–µ–∂–¥—É –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
    document.addEventListener('DOMContentLoaded', function () {
        var activeTab = localStorage.getItem('activeTab') || '#announcements';
        var tabBtn = document.querySelector('[role="tab"][href="' + activeTab + '"]');
        if (tabBtn) {
            tabBtn.click();
        }
    });
</script>
{% endblock %}