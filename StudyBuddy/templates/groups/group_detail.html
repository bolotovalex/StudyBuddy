{% extends 'base.html' %}

{% load static %}

{% block page_title %}
<div class="flex flex-col items-center justify-center gap-1 pt-2 pb-2">
    <span class="text-xl font-semibold text-center break-words">{{ group.name }}</span>
</div>
{% endblock %}

{% block content %}
<div class="w-full max-w-3xl mx-auto">

    <!-- –í–ö–õ–ê–î–ö–ò: —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, —Å–≤–µ—Ä—Ö—É -->
    <div class="sticky top-0 z-10 bg-base-200 mb-4">
        <div role="tablist" class="tabs tabs-bordered flex-nowrap overflow-x-auto no-scrollbar px-1">
            <a role="tab" class="tab tab-bordered tab-active" href="#announcements">–û–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a role="tab" class="tab tab-bordered" href="#documents">–î–æ–∫—É–º–µ–Ω—Ç—ã</a>
            <a role="tab" class="tab tab-bordered" href="#notes">–ö–æ–Ω—Å–ø–µ–∫—Ç—ã</a>
            <a role="tab" class="tab tab-bordered" href="#meetings">–í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏</a>
            <a role="tab" class="tab tab-bordered" href="#members">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</a>
        </div>
    </div>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tab-content-fixed-height {
            min-height: 420px;
        }
    </style>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-content-fixed-height relative mb-6">

        <!-- –û–±—ä—è–≤–ª–µ–Ω–∏—è -->
        <div id="announcements" class="tab-pane h-[80vh] flex flex-col">

  <!-- –®–∞–ø–∫–∞ -->
  <div class="bg-base-100 px-4 py-2 border-b shrink-0 sticky top-0 z-10">
    <h2 class="text-lg font-semibold">–û–±—ä—è–≤–ª–µ–Ω–∏—è</h2>
  </div>

  <!-- –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã–π —Å–ø–∏—Å–æ–∫ -->
  <div id="message-list" class="flex-1 overflow-y-auto px-4 py-2 space-y-2">
    {% for message in messages %}
      <div class="bg-base-200 rounded p-3">
        <span class="text-xs text-base-content/60">
          {{ message.timestamp|date:"d.m.Y H:i" }} ‚Äî
          {% if message.user == request.user %}
            –í—ã
          {% else %}
            {{ message.user.last_name }} {{ message.user.first_name }}
          {% endif %}
        </span>
        <p class="mt-1 whitespace-pre-line">{{ message.content }}</p>
      </div>
    {% empty %}
      <div class="text-base-content/60">–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
    {% endfor %}
  </div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
  <form id="chat-form" method="post" class="shrink-0 p-4 bg-base-100 border-t sticky bottom-0 z-10">
    {% csrf_token %}
    <textarea name="content" id="content" class="textarea textarea-bordered w-full mb-2"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
    <input type="hidden" name="group_id" value="{{ group.id }}">
    <button type="submit" class="btn btn-primary w-full">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫: –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å—Ç—É–ø -->
{% if request.user == group.owner %}
  <div class="mt-6">
    <h3 class="font-semibold mb-2">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å—Ç—É–ø</h3>
    <ul class="space-y-2">
      {% for user in group.access_requests.all %}
        <li class="flex justify-between items-center bg-base-200 rounded p-2">
          <span>{{ user.username }}</span>
          <div class="flex gap-2">
            <a href="{% url 'groups:accept_request' group.pk user.pk %}" class="btn btn-success btn-xs">–ü—Ä–∏–Ω—è—Ç—å</a>
            <a href="{% url 'groups:decline_request' group.pk user.pk %}" class="btn btn-error btn-xs">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
          </div>
        </li>
      {% empty %}
        <li class="text-base-content/60">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –¥–æ—Å—Ç—É–ø.</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

        <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
        <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
        <div id="documents" class="tab-pane hidden">
            <h2 class="text-lg font-semibold mb-3">–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                {% for document in documents %}
                <div class="flex flex-col items-center bg-base-200 rounded p-3">
                    <!-- –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞ -->
                    <div class="mb-2 cursor-pointer" onclick="toggleDescription(this)">
                        {% if document.get_file_type == 'pdf' %}
                        <span class="text-5xl text-error">üìÑ</span>
                        {% elif document.get_file_type == 'word' %}
                        <span class="text-5xl text-primary">üìÑ</span>
                        {% elif document.get_file_type == 'excel' %}
                        <span class="text-5xl text-success">üìÑ</span>
                        {% else %}
                        <span class="text-5xl">üìÑ</span>
                        {% endif %}
                    </div>
                    <!-- –ò–º—è —Ñ–∞–π–ª–∞ -->
                    <div class="mb-2 font-medium break-all text-center">{{ document.get_file_name }}</div>
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div class="text-xs text-base-content/70 mb-2 hidden">
                        {{ document.description|default:"–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∏ –≤ —Å—Ç—Ä–æ–∫—É -->
                    <div class="flex flex-row gap-2">
                        <a href="{{ document.file.url }}" target="_blank" class="btn btn-primary btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>
                        <a href="{% url 'documents:delete_document' document.id %}"
                            class="btn btn-error btn-sm">–£–¥–∞–ª–∏—Ç—å</a>
                    </div>
                </div>
                {% empty %}
                <p class="text-base-content/60 col-span-full">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
                {% endfor %}
            </div>
            <form method="post" enctype="multipart/form-data" action="{% url 'documents:add_document' group.id %}"
                class="space-y-2">
                {% csrf_token %}
                <label class="form-control w-full mb-2">
                    <span class="label-text">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç:</span>
                    <input type="file" name="file" id="file" class="file-input file-input-bordered w-full" required>
                </label>
                <textarea name="description" class="textarea textarea-bordered w-full"
                    placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞"></textarea>
                <button type="submit" class="btn btn-primary w-full">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
        </div>


        <!-- –ö–æ–Ω—Å–ø–µ–∫—Ç—ã -->
        <div id="notes" class="tab-pane hidden">
            <h2 class="text-lg font-semibold mb-3">–ö–æ–Ω—Å–ø–µ–∫—Ç—ã</h2>
            <ul class="space-y-2">
                {% for note in notes %}
                <li class="bg-base-200 rounded p-2">
                    <a href="{% url 'notes:note_etherpad_redirect' pad_id=note.etherpad_id %}" target="_blank" class="link">{{ note.title }}</a>
                </li>
                {% empty %}
                <li class="text-base-content/60">–ù–µ—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</li>
                {% endfor %}
            </ul>
            <a href="{% url 'notes:add_note' group.id %}" class="btn btn-outline btn-primary mt-4 w-full">–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç</a>
        </div>

        <!-- –í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏ -->
        <div id="meetings" class="tab-pane hidden">
            <h2 class="text-lg font-semibold mb-3">–í–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á–∏</h2>
            <ul class="space-y-2">
                {% for meeting in meetings %}
                    <li class="bg-base-200 rounded p-2 flex flex-row items-center justify-between">
                        <span>
                            <a href="{{ meeting.link }}" class="link">{{ meeting.title }}</a>
                            ‚Äî {{ meeting.scheduled_at|date:"d.m.Y H:i" }}
                        </span>
                        {% if user == meeting.created_by %}
                            <a href="{% url 'meetings:meeting_confirm_delete' meeting.id %}" class="btn btn-error btn-xs ml-2">–£–¥–∞–ª–∏—Ç—å</a>
                        {% endif %}

                    </li>
                {% empty %}
                    <li class="text-base-content/60">–ù–µ—Ç –≤–∏–¥–µ–æ–≤—Å—Ç—Ä–µ—á</li>
                {% endfor %}
            </ul>
            
            <form method="post" action="{% url 'meetings:add_meeting' group.id %}" class="space-y-2 mt-4">
                {% csrf_token %}
                <input type="text" name="title" class="input input-bordered w-full" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏"
                    required>
                <input type="datetime-local" name="scheduled_at" class="input input-bordered w-full" required>
                <button type="submit" class="btn btn-primary w-full">–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</button>
            </form>
        </div>

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã -->
        <div id="members" class="tab-pane hidden">
            <h2 class="text-lg font-semibold mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h2>
            <ul class="space-y-2">
                {% for member in members %}
                <li class="bg-base-200 rounded p-2 flex justify-between items-center">
                    <span>{{ member.username }}</span>
                    {% if member == group.owner %}
                    <span class="badge badge-primary">–í–ª–∞–¥–µ–ª–µ—Ü</span>
                    {% endif %}
                </li>
                {% empty %}
                <li class="text-base-content/60">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–µ –≤–∫–ª–∞–¥–∫–∏
    const tabNames = ['announcements', 'documents', 'notes', 'meetings', 'members'];
    document.querySelectorAll('[role="tab"]').forEach((tab, idx) => {
        tab.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelectorAll('[role="tab"]').forEach(t => t.classList.remove('tab-active'));
            this.classList.add('tab-active');
            document.querySelectorAll('.tab-pane').forEach((pane, i) => pane.classList.toggle('hidden', idx !== i));
            localStorage.setItem('activeTab', idx);
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const idx = parseInt(localStorage.getItem('activeTab') || "0");
        const tabs = document.querySelectorAll('[role="tab"]');
        if (tabs[idx]) tabs[idx].click();
    });

    // AJAX –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–∏–ª–∏ fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É)
    const form = document.getElementById('chat-form');
    const messageList = document.getElementById('message-list');
    if (form && messageList) {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const response = await fetch("{% url 'chat:send_message' %}", {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") }
            });
            const data = await response.json();
            if (data.status === 'success') {
                const newMessage = document.createElement('div');
                const timestamp = new Date().toLocaleString();
                const content = formData.get('content');
                newMessage.className = "bg-base-200 rounded p-3";
                newMessage.innerHTML = `<span class="text-xs text-base-content/60">${timestamp} ‚Äî –í—ã</span><br>${content}`;
                messageList.appendChild(newMessage);
                messageList.scrollTop = messageList.scrollHeight;
                form.reset();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        });
    }
</script>

<script>
    function toggleDescription(iconElem) {
        // –°–ª–µ–¥—É—é—â–∏–π .hidden-–±–ª–æ–∫ –ø–æ—Å–ª–µ –∏–∫–æ–Ω–∫–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
        const desc = iconElem.parentElement.querySelector('.text-xs');
        if (desc) desc.classList.toggle('hidden');
    }
</script>

{% endblock %}